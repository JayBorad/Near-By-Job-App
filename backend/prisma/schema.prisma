generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  DELETED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CategoryStatus {
  PENDING
  APPROVED
  REJECTED
}

enum JobType {
  ONE_TIME
  PART_TIME
  FULL_TIME
}

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model User {
  id             String            @id @default(uuid()) @db.Uuid
  supabaseAuthId String            @unique @db.Uuid
  name           String
  username       String            @unique
  email          String            @unique
  phone          String            @unique
  age            Int?
  gender         Gender?
  address        String?
  avatar         String?
  bio            String?
  role           Role              @default(USER)
  status         UserStatus        @default(ACTIVE)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  categories     Category[]        @relation("CategoryCreatedBy")
  approved       Category[]        @relation("CategoryApprovedBy")
  jobs           Job[]             @relation("JobCreatedBy")
  applications   JobApplication[]  @relation("ApplicationApplicant")
  sentMessages   ChatMessage[]     @relation("ChatSender")
  recvMessages   ChatMessage[]     @relation("ChatReceiver")

  @@index([role])
  @@index([status])
}

model Category {
  id           String         @id @default(uuid()) @db.Uuid
  name         String
  description  String?
  status       CategoryStatus @default(PENDING)
  createdBy    String         @db.Uuid
  approvedBy   String?        @db.Uuid
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  creator      User           @relation("CategoryCreatedBy", fields: [createdBy], references: [id])
  approver     User?          @relation("CategoryApprovedBy", fields: [approvedBy], references: [id])
  jobs         Job[]

  @@index([status])
  @@index([createdBy])
}

model Job {
  id            String            @id @default(uuid()) @db.Uuid
  title         String
  description   String
  categoryId    String            @db.Uuid
  budget        Decimal           @db.Decimal(12, 2)
  jobType       JobType
  latitude      Decimal           @db.Decimal(9, 6)
  longitude     Decimal           @db.Decimal(9, 6)
  address       String
  location      Unsupported("geography(Point,4326)")?
  status        JobStatus         @default(OPEN)
  dueDate       DateTime
  createdBy     String            @db.Uuid
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  category      Category          @relation(fields: [categoryId], references: [id])
  owner         User              @relation("JobCreatedBy", fields: [createdBy], references: [id])
  applications  JobApplication[]
  messages      ChatMessage[]

  @@index([status])
  @@index([categoryId])
  @@index([createdBy])
  @@index([deletedAt])
  @@index([dueDate])
}

model JobApplication {
  id           String            @id @default(uuid()) @db.Uuid
  jobId        String            @db.Uuid
  applicantId  String            @db.Uuid
  status       ApplicationStatus @default(PENDING)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  job          Job               @relation(fields: [jobId], references: [id])
  applicant    User              @relation("ApplicationApplicant", fields: [applicantId], references: [id])

  @@unique([jobId, applicantId])
  @@index([status])
  @@index([applicantId])
}

model ChatMessage {
  id         String   @id @default(uuid()) @db.Uuid
  jobId      String   @db.Uuid
  senderId   String   @db.Uuid
  receiverId String   @db.Uuid
  message    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  job        Job      @relation(fields: [jobId], references: [id])
  sender     User     @relation("ChatSender", fields: [senderId], references: [id])
  receiver   User     @relation("ChatReceiver", fields: [receiverId], references: [id])

  @@index([jobId, createdAt])
  @@index([senderId])
  @@index([receiverId])
}
